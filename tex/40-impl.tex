\chapter{Реализация}
\label{cha:impl}

\section{Разработка}

Разработанный модуль использует сервисы зарегистрированные в регистре сервисов фреймворка предоставленные модулями приведенными в приложение А рис.~\ref{fig:comps}, темным фоном выделен разработанный модуль.

Модуль Apache Sling Health Check Web Console Plugin ищет в регистре сервисов фреймворка, сервисы зарегистрированные по интерфейсу HealthCheck и удовлетворяющие введенным пользователем фильтрам. Поэтому разработанные проверки реализуют интерфейс HealthCheck и представляют из себя сервис-компоненты, рис.~\ref{fig:classDia}. Каждая проверка реализует метод "execute" возвращающий результат проверки в виде лога который записывается во время выполнения, листинг \ref{lst:simpleExecute}. Лог отображается в веб плагине, и на его основе выставляется статус проверки. Возможные статусы сообщений: "debug", "info", "warn" и "critical".

\begin{listing}[H]
\inputminted[linenos,frame=single]{java}{inc/src/simpleExecute}
\caption{Главный метод проверок} 
\label{lst:simpleExecute}
\end{listing}

Сервис-компоненты создаются при помощи аннотации @Component, объявляющей класс компонентом, и аннотации @Service указывающий сервис интерфейс реализуемый данным компонентом \cite{web:felixScr}. Для проверок задаются обязательные свойства с помощью аннотации @Property, листинг \ref{lst:scrComponent}.
\begin{itemize}
\item HealthCheck.NAME – Отображаемое имя проверки.
\item HealthCheck.TAGS – Тэги проверки.
\item HealthCheck.MBEAN\_NAME – Имя проверки в JMX.
\end{itemize}

\begin{listing}[H]
\inputminted[linenos,frame=single]{java}{inc/src/scrComponent}
\caption{Объявление сервис-компонента проверки} 
\label{lst:scrComponent}
\end{listing}

Конфигурация компонент задается так-же через аннотацию @Property указанную для полей класса, листинг \ref{lst:scrProperty}. 

\begin{listing}[H]
\inputminted[linenos,frame=single]{java}{inc/src/scrProperty}
\caption{Конфигурируемые параметры сервис-компонента} 
\label{lst:scrProperty}
\end{listing}

Как было описано выше, активация компонент происходит при доступе к ним, при этом вызывается метод помеченный аннотацией @Activate и выполняются действия необходимые для работы компонента, а именно извлекаются значения конфигурации с помощью метода ComponentContext.getProperties(), данный объект является уникальным для каждого сервис-компонента, листинг \ref{lst:scrActivate}. После использования компонента, вызывается метод помеченный аннотацией @Deactivate в котором выполняется высвобождение ресурсов.

\begin{listing}[H]
\inputminted[linenos,frame=single]{java}{inc/src/scrActivate}
\caption{Методы активации и деактивации сервис-компонента} 
\label{lst:scrActivate}
\end{listing}

Доступ к сервисам зарегистрированным в регистре сервисов осуществляется с помощью внедрения зависимостей, по средствам аннотации @Reference. Листинг \ref{lst:scrReference}.

%fontsize=\footnotesize
%\begin{mdframed}[frametitle={Конфигурация сервис-компонента}]
%	\inputminted[linenos,frame=single]{java}{inc/src/scrComponent}
	%\frametitle{Конфигурация сервис-компонента}
%	\label{lst:scrComponent}
%\end{mdframed}
\begin{listing}[H]
\inputminted[linenos,frame=single]{java}{inc/src/scrReference}
\caption{Доступ к сервисам} 
\label{lst:scrReference}
\end{listing}

\subsection{Подмодуль authentication}
Объект ComponentContext помимо параметров конфигурации позволяет получить контекст модулей системы тем самым предоставляя список всех модулей системы. В регистре сервисов системы зарегистрирован сервис ServiceComponentRuntime предоставляющий доступ к сервис-компонентам зарегистрированным в системе. Данный сервис предоставляет список всех сервис-компонентов зарегистрированных в системе для конкретного модуля. Во время выполнения проверки происходит проверка активность всех сервис-компонентов, все компоненты должны быть включены и для включенных проверяется статус, который должен быть active, если они не указаны в конфигурации как не активные.

\subsection{Подмодуль saml} 
Сервис AgentManager предоставляет доступ к списку агентов репликации в системе. Во время выполнения проверки агенты проверяются на соответствие конфигурации и для активных агентов выполняется тестовая репликация. Тестовая репликация выполняется с помощью метода объекта Agent – "replicate", с типом репликации TEST. На выполнение тестовой репликации вешается слушатель который и записывает логи тестовой репликации.

\subsection{Файлы конфигурации}
Файлы конфигурации созданные пользователями системы хранятся как узлы в JCR и должны находится по пути: /apps/*/config – для всех режимов работы, и по пути /apps/*/config.{режим} для заданного режима работы, а так же должны иметь базовый тип узла – sling:OsgiConfig. Приложение А рис.~\ref{fig:configTree}.

Были созданы файлы конфиграций проверок для режимов работы author и publish, а так-же создана конфигурация задающая composite health check для всех режимов работы, которая агрегирует результаты всех созданных проверок. Каждый узел конфигурации в пакете описывается XML файлом, имеющим следующий вид \ref{lst:xmlConfigExample}.

\begin{listing}[H]
\inputminted[linenos,frame=single]{xml}{inc/src/xmlConfigExample}
\caption{XML описывающий узлы в пакете установки} 
\label{lst:xmlConfigExample}
\end{listing}

\section{Тестирование}

Тестирование проходило в 2 этапа, локально и на тестовом сервере заказчика.
Для локального тестирования были развернуты – авторский экземпляр AEM, система Nagios \cite{web:nagiosInstall} с установленным плагином check-http-json и заданна следующая конфигурация:
\begin{itemize}
\item Активные агенты репликации: publish, offloading\_outbox.
\item Режимы работы: author, crx3, crx3tar, samplecontent.
\item Модуль "com.softwerke.test" с сервис-компонентами один из которых отключен.
\end{itemize}

\subsection{Тестирование сценария входа}
Для тестирования результатов проверки агентов репликации в конфигурации были заданны следующие параметры:
\begin{itemize}
\item compared.agents – [publish]
\item ignored.agents – [offloading\_outbox]
\item queue.size – 3
\end{itemize}

Ожидаемый результат проверки: "OK". Полученный результат: "OK".

\subsection{Тестирование сценария выхода}
Для тестирования результатов проверки доступности удаленных ресурсов в конфигурации были заданны следующие параметры:
\begin{itemize}
\item ping.url – [https://youtube.com, https://www.google.com]
\end{itemize}

Ожидаемый результат проверки: "OK". Полученный результат: "OK".

%\subsection{Блок-схема всякой ерунды}
%
%\subsubsection*{Кстати о заголовках}
%
%У нас есть и \Code{subsubsection}. Только лучше её не нумеровать.

\section{Документация}

По умолчанию в AEM предусмотрено два способа просмотра статуса и выполнения проверок:
\begin{itemize}
	\item Sling Web Console Plugin: плагин позволяет запускать выполнение проверок с различными параметрами. Доступ к плагину осуществляется через веб интерфейс по пути: http://hostname/system/console/healthcheck 
\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{inc/svg/pluginMenu}
  \caption{Интерфейс Web плагина}
  \label{fig:pluginMenu}
\end{figure}
	\item AEM Health Reports: система карточек, являющаяся визуализацией проверок. Проверки могут быть объединены под общей карточкой по общему тегу если задана составная проверка. Составная проверка имеет самый худший статус. В карточках есть возможность посмотреть полный лог проверки и её конфигурацию. Доступ к Health Reports осуществляется через веб интерфейс по пути: http://hostname/libs/granite/operations/content/healthreports.html
\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{inc/svg/demoReport}
  \caption{Статус проверок}
  \label{fig:demoReport}
\end{figure}
\end{itemize}
		
Интеграция проверок с Nagios реализована с помощью check\_http\_json плагина. Используемый плагин парсит JSON файл и передает в Nagios статус проверки, который может быть: "OK", "WARN" или "CRITICAL". Этот статус и отображается в панели управления Nagios. Так же в панели управления Nagios можно посмотреть лог выполнения проверки.
\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{inc/svg/nagiosMonitor}
  \caption{Конфигурация проверки}
  \label{fig:nagiosMonitor}
\end{figure}

\paragraph{Replication Agents Health Check}
При наличие в системе агентов не указанных ни в одном из параметров, или отсутствии сравниваемых агентов проверка считается неудачной.
Конфигурация проверки имеет следующие параметры:
\begin{itemize}
\item compared.agents – Список MBean имен агентов, существование которых необходимо проверить.
\item ignored.agents – Список MBean имен агентов, которые игнорируются в ходе проверки.
\item queue.size – Параметр задает максимально допустимый для агентов размер очереди репликации. Значение по умолчанию 3.
\end{itemize}

\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{inc/svg/agentConfig}
  \caption{Конфигурация проверки}
  \label{fig:agentConfig}
\end{figure}


\paragraph{Bundle Component Health Check}
В списке модулей указывается полные символьные имена модулей. Список не активных сервис-компонентов задается указанием PID каждого компонента.
Конфигурация проверки имеет следующие параметры:
\begin{itemize}
\item testing.bundles – Список символьных имен модулей, наличие и статус которых требуется проверить.
\item inactive.components – Список имен сервис компонент статус которых должен быть "UNSATISFIED REFERENCE" или "UNSATISIFIED CONFIGURATION".
\end{itemize}

\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{inc/svg/bundlesConfig}
  \caption{Конфигурация проверки}
  \label{fig:bundlesConfig}
\end{figure}

\paragraph{Ping Health Check}
Параметры конфигурации:
\begin{itemize}
\item ping.url – Список URL ресурсов, доступность которых необходимо проверить.
\end{itemize}

\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{inc/svg/pingConfig}
  \caption{Конфигурация проверки}
  \label{fig:pingConfig}
\end{figure}

\paragraph{Run Modes Health Check}
Только полное соответствие режимов системы с режимами из конфигурации допустимо. Конфигурация проверки имеет следующие параметры:
\begin{itemize}
\item compared.run.modes – Список имен режимов запуска, которые должны быть заданы в системе.
\end{itemize}

\begin{figure}[H]
  \centering
  \includegraphics[width=\textwidth]{inc/svg/runConfig}
  \caption{Конфигурация проверки}
  \label{fig:runConfig}
\end{figure}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "rpz"
%%% End:

